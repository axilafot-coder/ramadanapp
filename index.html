import React, { useState, useEffect, useMemo } from 'react';
import { 
  CheckCircle2, Loader2, ChevronRight, ChevronLeft, Plus, Minus, 
  LayoutDashboard, ClipboardList, Moon, Sun, Star, Trash2
} from 'lucide-react';

// --- Configuration & Defaults ---
const DAYS_OF_RAMADAN = 30;
const DAILY_TARGET = 2000; 
const STORAGE_KEY = 'ramadan_pro_local_v3_data';
const PROFILE_KEY = 'ramadan_pro_local_v3_profile';

const PRAYERS = [
  { id: 'fajr', name: 'Fajr', target: 2 },
  { id: 'dhuhr', name: 'Dhuhr', target: 4 },
  { id: 'asr', name: 'Asr', target: 2 },
  { id: 'maghrib', name: 'Maghrib', target: 2 },
  { id: 'isha', name: 'Isha', target: 2 },
];

const INITIAL_DAY_DATA = {
  fasting: true,
  prayers: {
    fajr: { completed: false, masjid: false, group: false, rawatib: 0 },
    dhuhr: { completed: false, masjid: false, group: false, rawatib: 0 },
    asr: { completed: false, masjid: false, group: false, rawatib: 0 },
    maghrib: { completed: false, masjid: false, group: false, rawatib: 0 },
    isha: { completed: false, masjid: false, group: false, rawatib: 0 },
  },
  tahajjudRakah: 0,
  taraweehCompleted: false,
  witrCompleted: false,
  duhaCompleted: false,
  quranJuz: 0,
  sadaqah: false,
  azkarCount: 0,
  haddad: false,
  salawatCount: 0,
  manualEvaluation: 50,
  reflections: ""
};

export default function App() {
  const [profile, setProfile] = useState({ name: '', gender: '' });
  const [activeTab, setActiveTab] = useState('log');
  const [selectedDay, setSelectedDay] = useState(1);
  const [allData, setAllData] = useState({});
  const [loading, setLoading] = useState(true);
  const [showOnboarding, setShowOnboarding] = useState(false);

  // Load data from Local Storage on mount
  useEffect(() => {
    const savedProfile = localStorage.getItem(PROFILE_KEY);
    const savedData = localStorage.getItem(STORAGE_KEY);

    if (savedProfile) {
      setProfile(JSON.parse(savedProfile));
      setShowOnboarding(false);
    } else {
      setShowOnboarding(true);
    }

    if (savedData) {
      setAllData(JSON.parse(savedData));
    }
    
    setLoading(false);
  }, []);

  // Persistence logic
  const persistData = (data) => {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    setAllData(data);
  };

  const saveProfile = (data) => {
    localStorage.setItem(PROFILE_KEY, JSON.stringify(data));
    setProfile(data);
    setShowOnboarding(false);
  };

  const updateDayData = (day, updates) => {
    const dayExisting = allData[day] || { ...INITIAL_DAY_DATA };
    const newDayData = { ...dayExisting, ...updates };
    const newData = { ...allData, [day]: newDayData };
    persistData(newData);
  };

  const resetAllData = () => {
    if (window.confirm("Are you sure? This will delete all local progress.")) {
      localStorage.removeItem(STORAGE_KEY);
      setAllData({});
    }
  };

  const calculateDayScore = (data) => {
    if (!data) return 0;
    let score = 0;
    
    PRAYERS.forEach(pDef => {
      const p = (data.prayers && data.prayers[pDef.id]) || INITIAL_DAY_DATA.prayers[pDef.id];
      if (p.completed) {
        score += 50; 
        if (p.group) score += 50;
        if (p.masjid) score += 50;
      }
      score += (p.rawatib || 0) * 10; 
    });

    if (data.fasting) score += 100;
    score += (data.tahajjudRakah || 0) * 50;
    if (data.taraweehCompleted) score += 200;
    if (data.quranJuz > 0) score += (data.quranJuz * 100);
    
    return score;
  };

  const currentDayData = allData[selectedDay] || INITIAL_DAY_DATA;
  const currentScore = calculateDayScore(currentDayData);
  const meterPercentage = Math.min(100, (currentScore / DAILY_TARGET) * 100);

  if (loading) return (
    <div className="min-h-screen bg-black flex items-center justify-center">
      <Loader2 className="animate-spin text-emerald-500" />
    </div>
  );

  if (showOnboarding) {
    return (
      <div className="min-h-screen bg-slate-950 text-white flex items-center justify-center p-6">
        <div className="w-full max-w-sm space-y-8 bg-slate-900/50 p-8 rounded-[40px] border border-slate-800 backdrop-blur-2xl text-center">
          <div className="space-y-2">
            <h2 className="text-3xl font-black italic tracking-tighter">RAMADAN <span className="text-emerald-500">PRO</span></h2>
            <p className="text-[10px] text-slate-500 font-bold uppercase tracking-[0.3em]">Local Storage Edition</p>
          </div>
          <div className="space-y-4">
            <input 
              type="text" 
              placeholder="Your Name"
              className="w-full bg-slate-800 border-2 border-slate-700 rounded-2xl px-5 py-4 text-sm font-bold outline-none focus:border-emerald-500 transition-all"
              value={profile.name}
              onChange={(e) => setProfile({ ...profile, name: e.target.value })}
            />
            <div className="grid grid-cols-2 gap-3">
              <button 
                onClick={() => setProfile({ ...profile, gender: 'male' })}
                className={`py-4 rounded-2xl border-2 font-black text-[10px] uppercase tracking-widest transition-all ${profile.gender === 'male' ? 'bg-emerald-500 text-slate-950 border-emerald-400' : 'bg-slate-800 border-slate-700 text-slate-500'}`}
              >Brother</button>
              <button 
                onClick={() => setProfile({ ...profile, gender: 'female' })}
                className={`py-4 rounded-2xl border-2 font-black text-[10px] uppercase tracking-widest transition-all ${profile.gender === 'female' ? 'bg-emerald-500 text-slate-950 border-emerald-400' : 'bg-slate-800 border-slate-700 text-slate-500'}`}
              >Sister</button>
            </div>
            <button 
              disabled={!profile.name || !profile.gender}
              onClick={() => saveProfile(profile)}
              className="w-full bg-white text-slate-950 font-black py-5 rounded-2xl text-[11px] uppercase tracking-[0.2em] shadow-xl shadow-white/10 disabled:opacity-20 mt-4 active:scale-95 transition-transform"
            >Enter Oasis</button>
          </div>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-slate-950 text-slate-100 pb-24 font-sans select-none">
      {/* App Header */}
      <header className="px-6 py-4 flex justify-between items-center sticky top-0 bg-slate-950/80 backdrop-blur-lg z-50 border-b border-slate-900/50">
        <div>
          <h1 className="text-xl font-black italic">RAMADAN <span className="text-emerald-500">PRO</span></h1>
          <p className="text-[9px] text-slate-500 font-bold uppercase tracking-widest flex items-center gap-1.5">
            <span className="w-1.5 h-1.5 bg-emerald-500 rounded-full animate-pulse" />
            Offline Mode â€¢ {profile.name}
          </p>
        </div>
        <div className="bg-emerald-500 text-slate-950 px-4 py-1.5 rounded-full text-center shadow-lg shadow-emerald-500/20">
          <div className="text-xs font-black">{Math.floor(currentScore)}</div>
          <div className="text-[7px] font-bold uppercase tracking-tighter opacity-70">Points</div>
        </div>
      </header>

      <main className="px-4 py-6 max-w-md mx-auto space-y-6">
        {activeTab === 'dashboard' ? (
          <div className="space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500">
            {/* Heatmap */}
            <section className="bg-slate-900/50 rounded-[32px] p-6 border border-slate-800/50">
              <h3 className="text-[10px] font-black uppercase text-slate-500 mb-5 tracking-[0.2em] text-center">30 Day Journey Map</h3>
              <div className="grid grid-cols-6 gap-2">
                {Array.from({ length: 30 }, (_, i) => {
                  const day = i + 1;
                  const score = calculateDayScore(allData[day]);
                  const pct = (score / DAILY_TARGET) * 100;
                  const isActive = selectedDay === day;
                  
                  let cellStyle = "bg-slate-800/50 text-slate-600";
                  if (score > 0) {
                    if (pct >= 80) cellStyle = "bg-emerald-500 text-slate-950";
                    else if (pct >= 40) cellStyle = "bg-emerald-800 text-emerald-100";
                    else cellStyle = "bg-emerald-950 text-emerald-500";
                  }

                  return (
                    <button 
                      key={day}
                      onClick={() => { setSelectedDay(day); setActiveTab('log'); }}
                      className={`aspect-square rounded-xl text-[10px] font-black transition-all ${cellStyle} ${isActive ? 'ring-2 ring-white ring-offset-4 ring-offset-slate-950 scale-110' : 'hover:scale-105 active:scale-95'}`}
                    >
                      {day}
                    </button>
                  );
                })}
              </div>
            </section>

            <button 
              onClick={resetAllData}
              className="w-full flex items-center justify-center gap-2 py-4 text-slate-600 hover:text-rose-500 transition-colors text-[10px] font-black uppercase tracking-widest"
            >
              <Trash2 size={14} /> Reset Local Data
            </button>
          </div>
        ) : (
          <div className="space-y-5 animate-in fade-in slide-in-from-bottom-4 duration-500">
            {/* Day Selector */}
            <div className="flex items-center justify-between bg-slate-900/50 rounded-2xl p-2 border border-slate-800/50">
               <button onClick={() => setSelectedDay(d => Math.max(1, d-1))} className="p-3 text-slate-400 hover:text-white"><ChevronLeft size={20}/></button>
               <div className="flex flex-col items-center">
                 <span className="text-[10px] font-black uppercase tracking-[0.2em] text-emerald-500">Day</span>
                 <span className="text-2xl font-black italic">{selectedDay}</span>
               </div>
               <button onClick={() => setSelectedDay(d => Math.min(30, d+1))} className="p-3 text-slate-400 hover:text-white"><ChevronRight size={20}/></button>
            </div>

            {/* Progress Meter */}
            <div className="bg-slate-900 rounded-[24px] p-5 border border-slate-800">
              <div className="flex justify-between items-center mb-3">
                <span className="text-[9px] font-black uppercase text-slate-500 tracking-widest italic">Day Efficiency</span>
                <span className="text-xs font-black text-emerald-400">{Math.round(meterPercentage)}%</span>
              </div>
              <div className="h-2 bg-slate-800 rounded-full overflow-hidden">
                <div 
                  className="h-full bg-emerald-500 shadow-[0_0_15px_rgba(16,185,129,0.4)] transition-all duration-700 ease-out"
                  style={{ width: `${meterPercentage}%` }}
                />
              </div>
            </div>

            {/* Prayer List */}
            <div className="space-y-2">
              {PRAYERS.map(p => {
                const d = currentDayData.prayers?.[p.id] || { ...INITIAL_DAY_DATA.prayers[p.id] };
                return (
                  <div key={p.id} className="bg-slate-900/80 border border-slate-800/50 rounded-2xl p-2.5 flex items-center gap-3">
                    <button 
                      onClick={() => {
                        const ps = { ...(currentDayData.prayers || INITIAL_DAY_DATA.prayers) };
                        ps[p.id] = { ...d, completed: !d.completed };
                        updateDayData(selectedDay, { prayers: ps });
                      }}
                      className={`w-10 h-10 rounded-xl flex items-center justify-center transition-all ${d.completed ? 'bg-emerald-500 text-slate-950 shadow-lg shadow-emerald-500/20' : 'bg-slate-800 text-slate-600'}`}
                    >
                      <CheckCircle2 size={18} />
                    </button>
                    <div className="flex-grow">
                      <p className={`text-[12px] font-black uppercase ${d.completed ? 'text-white' : 'text-slate-500'}`}>{p.name}</p>
                    </div>
                    <div className="flex gap-1.5">
                       <button 
                        onClick={() => {
                          const ps = { ...(currentDayData.prayers || INITIAL_DAY_DATA.prayers) };
                          ps[p.id] = { ...d, group: !d.group };
                          updateDayData(selectedDay, { prayers: ps });
                        }}
                        className={`px-3 py-2 rounded-lg text-[8px] font-black transition-all ${d.group ? 'bg-emerald-500 text-slate-950' : 'bg-slate-800 text-slate-500'}`}
                       >GRP</button>
                       <button 
                        onClick={() => {
                          const ps = { ...(currentDayData.prayers || INITIAL_DAY_DATA.prayers) };
                          ps[p.id] = { ...d, masjid: !d.masjid };
                          updateDayData(selectedDay, { prayers: ps });
                        }}
                        className={`px-3 py-2 rounded-lg text-[8px] font-black transition-all ${d.masjid ? 'bg-indigo-500 text-white' : 'bg-slate-800 text-slate-500'}`}
                       >MSJ</button>
                    </div>
                  </div>
                );
              })}
            </div>

            {/* Quran Section */}
            <div className="bg-emerald-950/20 border border-emerald-500/20 rounded-[24px] p-5 flex items-center justify-between">
                <div>
                  <h4 className="text-[11px] font-black uppercase text-emerald-200">Quran Reading</h4>
                  <p className="text-[8px] font-bold text-emerald-500/60 uppercase">Juz Completed</p>
                </div>
                <div className="flex items-center gap-5 bg-slate-900 p-1.5 rounded-xl border border-white/5">
                  <button onClick={() => updateDayData(selectedDay, { quranJuz: Math.max(0, (currentDayData.quranJuz || 0) - 1) })} className="p-2 text-slate-400 hover:text-white"><Minus size={18}/></button>
                  <span className="text-xl font-black text-emerald-400 font-mono w-6 text-center">{currentDayData.quranJuz || 0}</span>
                  <button onClick={() => updateDayData(selectedDay, { quranJuz: (currentDayData.quranJuz || 0) + 1 })} className="p-2 text-slate-400 hover:text-white"><Plus size={18}/></button>
                </div>
            </div>

            {/* Reflection Area */}
            <div className="space-y-2">
                <label className="text-[9px] font-black uppercase text-slate-500 tracking-widest px-2 italic">Reflections & Duas</label>
                <textarea 
                  value={currentDayData.reflections || ""}
                  onChange={(e) => updateDayData(selectedDay, { reflections: e.target.value })}
                  placeholder="The spiritual highlights of my day..."
                  className="w-full bg-slate-900 border border-slate-800 rounded-2xl p-4 text-xs text-slate-300 outline-none focus:ring-1 focus:ring-emerald-500/50 min-h-[100px] resize-none"
                />
            </div>
          </div>
        )}
      </main>

      {/* Navigation */}
      <nav className="fixed bottom-0 left-0 right-0 bg-slate-950/80 backdrop-blur-2xl border-t border-slate-900 px-8 py-4 flex justify-around items-center z-50">
        <button 
          onClick={() => setActiveTab('dashboard')}
          className={`flex flex-col items-center gap-1.5 transition-all ${activeTab === 'dashboard' ? 'text-emerald-500 scale-110' : 'text-slate-500'}`}
        >
          <LayoutDashboard size={22} />
          <span className="text-[8px] font-black uppercase tracking-tighter">Stats</span>
        </button>
        <button 
          onClick={() => setActiveTab('log')}
          className={`flex flex-col items-center gap-1.5 transition-all ${activeTab === 'log' ? 'text-emerald-500 scale-110' : 'text-slate-500'}`}
        >
          <ClipboardList size={22} />
          <span className="text-[8px] font-black uppercase tracking-tighter">Journal</span>
        </button>
      </nav>
    </div>
  );
}
