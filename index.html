<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Ramadan Pro Tracker</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font from Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #020617; /* Slate 950 */
            margin: 0;
            -webkit-tap-highlight-color: transparent;
            color: #f1f5f9;
        }
        #root {
            min-height: 100vh;
        }
        /* Custom scrollbar for a premium look */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #020617;
        }
        ::-webkit-scrollbar-thumb {
            background: #1e293b;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #334155;
        }
        /* Animation for smooth transitions */
        .fade-enter {
            opacity: 0;
            transform: translateY(10px);
        }
        .fade-enter-active {
            opacity: 1;
            transform: translateY(0);
            transition: opacity 300ms, transform 300ms;
        }
    </style>
</head>
<body>
    <!-- The React application will be mounted inside this div -->
    <div id="root"></div>
    
    <!-- Load React and Babel from CDNs -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Load Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Load Firebase via Module -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        // Make Firebase available globally for the Babel script
        window.FB = { initializeApp, getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken, getFirestore, doc, setDoc, onSnapshot, getDoc, updateDoc };
    </script>

    <!-- Main App Script -->
    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- Helper: App Configuration ---
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'ramadan-pro-github';

        // --- Data Constants ---
        const DAYS_OF_RAMADAN = 30;
        const DAILY_TARGET = 2000;
        const PRAYERS = [
            { id: 'fajr', name: 'Fajr' },
            { id: 'dhuhr', name: 'Dhuhr' },
            { id: 'asr', name: 'Asr' },
            { id: 'maghrib', name: 'Maghrib' },
            { id: 'isha', name: 'Isha' },
        ];

        const INITIAL_DAY_DATA = {
            fasting: true,
            prayers: {
                fajr: { completed: false, masjid: false },
                dhuhr: { completed: false, masjid: false },
                asr: { completed: false, masjid: false },
                maghrib: { completed: false, masjid: false },
                isha: { completed: false, masjid: false },
            },
            taraweeh: false,
            quranPages: 0
        };

        // --- UI Components ---
        const Card = ({ children, className = "" }) => (
            <div className={`bg-slate-900/50 border border-slate-800 rounded-3xl overflow-hidden backdrop-blur-sm ${className}`}>
                {children}
            </div>
        );

        const Icon = ({ name, size = 20, className = "" }) => {
            useEffect(() => {
                if (window.lucide) {
                    window.lucide.createIcons();
                }
            });
            return <i data-lucide={name} style={{ width: size, height: size }} className={className}></i>;
        };

        // --- Main App Component ---
        function App() {
            const [user, setUser] = useState(null);
            const [profile, setProfile] = useState(null);
            const [allData, setAllData] = useState({});
            const [selectedDay, setSelectedDay] = useState(1);
            const [activeTab, setActiveTab] = useState('log');
            const [loading, setLoading] = useState(true);
            const [isSaving, setIsSaving] = useState(false);

            // 1. Initialize Firebase Auth
            useEffect(() => {
                if (!window.FB || !firebaseConfig.apiKey) {
                    setLoading(false);
                    return;
                }
                const auth = window.FB.getAuth(window.FB.initializeApp(firebaseConfig));
                
                const initAuth = async () => {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await window.FB.signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await window.FB.signInAnonymously(auth);
                    }
                };
                initAuth();

                const unsubscribe = window.FB.onAuthStateChanged(auth, (u) => {
                    setUser(u);
                });
                return () => unsubscribe();
            }, []);

            // 2. Fetch User Data
            useEffect(() => {
                if (!user || !window.FB) return;
                const db = window.FB.getFirestore();
                
                // Fetch Profile
                const profileRef = window.FB.doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'profile');
                const unsubProfile = window.FB.onSnapshot(profileRef, (snap) => {
                    if (snap.exists()) setProfile(snap.data());
                    else setProfile({ name: 'User', gender: 'male' });
                });

                // Fetch Main Data
                const dataRef = window.FB.doc(db, 'artifacts', appId, 'users', user.uid, 'ramadanData', 'main');
                const unsubData = window.FB.onSnapshot(dataRef, (snap) => {
                    if (snap.exists()) setAllData(snap.data());
                    setLoading(false);
                }, () => setLoading(false));

                return () => { unsubProfile(); unsubData(); };
            }, [user]);

            // 3. Update Logic
            const updateDay = async (day, updates) => {
                const dayData = allData[day] || { ...INITIAL_DAY_DATA };
                const updatedDay = { ...dayData, ...updates };
                const newAllData = { ...allData, [day]: updatedDay };
                
                setAllData(newAllData);

                if (user && window.FB) {
                    setIsSaving(true);
                    const db = window.FB.getFirestore();
                    await window.FB.setDoc(window.FB.doc(db, 'artifacts', appId, 'users', user.uid, 'ramadanData', 'main'), newAllData);
                    setTimeout(() => setIsSaving(false), 500);
                }
            };

            const currentDayData = allData[selectedDay] || INITIAL_DAY_DATA;

            // Score Calculation
            const score = useMemo(() => {
                let s = 0;
                const d = currentDayData;
                Object.values(d.prayers || {}).forEach(p => {
                    if (p.completed) s += 100;
                    if (p.masjid) s += 50;
                });
                if (d.taraweeh) s += 200;
                s += (d.quranPages || 0) * 10;
                return s;
            }, [currentDayData]);

            if (loading) {
                return (
                    <div className="min-h-screen bg-slate-950 flex flex-col items-center justify-center text-emerald-500 gap-4">
                        <div className="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-emerald-500"></div>
                        <p className="font-bold tracking-widest text-xs uppercase">Initializing Ramadan Pro...</p>
                    </div>
                );
            }

            return (
                <div className="max-w-md mx-auto min-h-screen pb-24 relative">
                    {/* Header */}
                    <header className="p-6 flex justify-between items-center sticky top-0 bg-slate-950/80 backdrop-blur-md z-50">
                        <div>
                            <h1 className="text-2xl font-black italic tracking-tighter">RAMADAN <span className="text-emerald-500">PRO</span></h1>
                            <p className="text-[10px] text-slate-500 font-bold uppercase tracking-widest">Day {selectedDay} â€¢ {profile?.name || 'User'}</p>
                        </div>
                        <div className="bg-emerald-500 text-slate-950 px-5 py-2 rounded-2xl shadow-lg shadow-emerald-500/20 text-center">
                            <div className="text-xl font-black leading-none">{score}</div>
                            <div className="text-[8px] font-bold uppercase tracking-wider">Points</div>
                        </div>
                    </header>

                    <main className="px-6 space-y-6">
                        {/* Day Selector */}
                        <div className="flex justify-between items-center bg-slate-900/50 border border-slate-800 p-2 rounded-2xl">
                            <button onClick={() => setSelectedDay(d => Math.max(1, d - 1))} className="p-3 text-slate-400"><Icon name="chevron-left" /></button>
                            <span className="font-black text-sm tracking-widest">MARCH / DAY {selectedDay}</span>
                            <button onClick={() => setSelectedDay(d => Math.min(30, d + 1))} className="p-3 text-slate-400"><Icon name="chevron-right" /></button>
                        </div>

                        {/* Fasting Card */}
                        <Card className={`p-5 transition-all duration-300 ${currentDayData.fasting ? 'border-emerald-500/30' : 'border-slate-800'}`}>
                            <div className="flex items-center justify-between">
                                <div className="flex items-center gap-4">
                                    <div className={`w-12 h-12 rounded-2xl flex items-center justify-center ${currentDayData.fasting ? 'bg-emerald-500 text-slate-950' : 'bg-slate-800 text-slate-500'}`}>
                                        <Icon name="moon" />
                                    </div>
                                    <div>
                                        <p className="font-black text-white">Fasting</p>
                                        <p className="text-xs text-slate-500">Sawm completed today</p>
                                    </div>
                                </div>
                                <button 
                                    onClick={() => updateDay(selectedDay, { fasting: !currentDayData.fasting })}
                                    className={`w-14 h-8 rounded-full relative transition-all ${currentDayData.fasting ? 'bg-emerald-500' : 'bg-slate-700'}`}
                                >
                                    <div className={`absolute top-1 w-6 h-6 bg-white rounded-full transition-all ${currentDayData.fasting ? 'left-7' : 'left-1'}`} />
                                </button>
                            </div>
                        </Card>

                        {/* Prayers Section */}
                        <div className="space-y-3">
                            <p className="text-[10px] font-black uppercase tracking-widest text-slate-500 ml-1">Daily Prayers (Salah)</p>
                            <div className="grid gap-3">
                                {PRAYERS.map(p => {
                                    const prayers = currentDayData.prayers || {};
                                    const pData = prayers[p.id] || { completed: false, masjid: false };
                                    return (
                                        <div key={p.id} className="bg-slate-900/40 p-4 rounded-3xl border border-slate-800 flex items-center justify-between">
                                            <div className="flex items-center gap-4">
                                                <button 
                                                    onClick={() => {
                                                        const newP = { ...prayers, [p.id]: { ...pData, completed: !pData.completed } };
                                                        updateDay(selectedDay, { prayers: newP });
                                                    }}
                                                    className={`w-10 h-10 rounded-xl flex items-center justify-center transition-all ${pData.completed ? 'bg-emerald-500 text-slate-950' : 'bg-slate-800 text-slate-600'}`}
                                                >
                                                    <Icon name="check-circle-2" />
                                                </button>
                                                <span className="font-bold">{p.name}</span>
                                            </div>
                                            <button 
                                                onClick={() => {
                                                    const newP = { ...prayers, [p.id]: { ...pData, masjid: !pData.masjid } };
                                                    updateDay(selectedDay, { prayers: newP });
                                                }}
                                                className={`px-4 py-2 rounded-xl text-[9px] font-black tracking-widest transition-all ${pData.masjid ? 'bg-indigo-600 text-white' : 'bg-slate-800 text-slate-500'}`}
                                            >
                                                MASJID
                                            </button>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>

                        {/* Taraweeh & Quran */}
                        <div className="grid grid-cols-2 gap-4">
                            <Card 
                                onClick={() => updateDay(selectedDay, { taraweeh: !currentDayData.taraweeh })}
                                className={`p-4 cursor-pointer text-center space-y-2 border-2 ${currentDayData.taraweeh ? 'border-emerald-500 bg-emerald-500/10' : 'border-transparent'}`}
                            >
                                <Icon name="stars" className="mx-auto text-emerald-500" />
                                <p className="font-black text-xs uppercase tracking-widest">Taraweeh</p>
                            </Card>
                            <Card className="p-4 flex flex-col items-center justify-center gap-2">
                                <div className="flex items-center gap-2">
                                    <button onClick={() => updateDay(selectedDay, { quranPages: Math.max(0, (currentDayData.quranPages || 0) - 1) })} className="text-slate-500"><Icon name="minus" size={14}/></button>
                                    <span className="text-xl font-black">{currentDayData.quranPages || 0}</span>
                                    <button onClick={() => updateDay(selectedDay, { quranPages: (currentDayData.quranPages || 0) + 1 })} className="text-emerald-500"><Icon name="plus" size={14}/></button>
                                </div>
                                <p className="text-[8px] font-black uppercase tracking-widest text-slate-500">Quran Pages</p>
                            </Card>
                        </div>
                    </main>

                    {/* Navigation */}
                    <nav className="fixed bottom-0 left-0 right-0 p-6 bg-slate-950/80 backdrop-blur-xl border-t border-slate-900 flex justify-around items-center z-50">
                        <button onClick={() => setActiveTab('log')} className={`flex flex-col items-center gap-1 ${activeTab === 'log' ? 'text-emerald-500' : 'text-slate-600'}`}>
                            <Icon name="history" />
                            <span className="text-[8px] font-black uppercase">Tracker</span>
                        </button>
                        <button onClick={() => setActiveTab('stats')} className={`flex flex-col items-center gap-1 ${activeTab === 'stats' ? 'text-emerald-500' : 'text-slate-600'}`}>
                            <Icon name="bar-chart-3" />
                            <span className="text-[8px] font-black uppercase">Stats</span>
                        </button>
                    </nav>

                    {/* Saving Indicator */}
                    {isSaving && (
                        <div className="fixed top-20 left-1/2 -translate-x-1/2 bg-slate-800 text-emerald-400 px-3 py-1 rounded-full text-[9px] font-bold flex items-center gap-2 animate-bounce z-[60]">
                            <div className="w-1.5 h-1.5 bg-emerald-400 rounded-full"></div>
                            SAVING SYNC...
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
