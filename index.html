<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ramadan Pro - Spiritual Tracker</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect } = React;
        const { initializeApp } = window.firebase;
        const { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } = window.firebase.auth;
        const { getFirestore, doc, setDoc, onSnapshot } = window.firebase.firestore;

        // ⚠️ Firebase Config - Replace with your own
        const firebaseConfig = {
            apiKey: "AIzaSyBA-0sR3quTqAdzNNpAK8CCHw19jDi2je4",
            authDomain: "ramadanapp-13ef8.firebaseapp.com",
            projectId: "ramadanapp-13ef8",
            storageBucket: "ramadanapp-13ef8.firebasestorage.app",
            messagingSenderId: "858912691110",
            appId: "1:858912691110:web:2e43b35ec9164db2a13567",
            measurementId: "G-FV3FJWG9VM"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = "ramadan-pro-v3-final";

        const PRAYERS = [
            { id: 'fajr', name: 'Fajr', target: 2 },
            { id: 'dhuhr', name: 'Dhuhr', target: 4 },
            { id: 'asr', name: 'Asr', target: 2 },
            { id: 'maghrib', name: 'Maghrib', target: 2 },
            { id: 'isha', name: 'Isha', target: 2 },
        ];

        const INITIAL_DAY_DATA = {
            fasting: true,
            prayers: {
                fajr: { completed: false, masjid: false, group: false, rawatib: 0 },
                dhuhr: { completed: false, masjid: false, group: false, rawatib: 0 },
                asr: { completed: false, masjid: false, group: false, rawatib: 0 },
                maghrib: { completed: false, masjid: false, group: false, rawatib: 0 },
                isha: { completed: false, masjid: false, group: false, rawatib: 0 },
            },
            tahajjudRakah: 0,
            taraweehCompleted: false,
            witrCompleted: false,
            duhaCompleted: false,
            quranJuz: 0,
            sadaqah: false,
            azkarCount: 0,
            haddad: false,
            salawatCount: 0,
            manualEvaluation: 50,
            reflections: ""
        };

        const DAYS_OF_RAMADAN = 30;
        const DAILY_TARGET = 2000;

        function App() {
            const [user, setUser] = useState(null);
            const [profile, setProfile] = useState({ name: '', gender: '' });
            const [activeTab, setActiveTab] = useState('log');
            const [selectedDay, setSelectedDay] = useState(1);
            const [allData, setAllData] = useState({});
            const [loading, setLoading] = useState(true);
            const [isSaving, setIsSaving] = useState(false);
            const [showOnboarding, setShowOnboarding] = useState(false);

            // Auth initialization
            useEffect(() => {
                const initAuth = async () => {
                    try {
                        await signInAnonymously(auth);
                    } catch (e) { 
                        console.error("Auth error:", e);
                        setLoading(false);
                    }
                };
                initAuth();
                const unsubscribe = onAuthStateChanged(auth, u => {
                    if (u) setUser(u);
                });
                return () => unsubscribe();
            }, []);

            // Sync data from Firestore
            useEffect(() => {
                if (!user) return;
                const profileRef = doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'profile');
                const unsubscribeProfile = onSnapshot(profileRef, (docSnap) => {
                    if (docSnap.exists()) {
                        setProfile(docSnap.data());
                        setShowOnboarding(false);
                    } else {
                        setShowOnboarding(true);
                    }
                }, () => setShowOnboarding(true));

                const dataRef = doc(db, 'artifacts', appId, 'users', user.uid, 'ramadanData', 'main');
                const unsubscribeData = onSnapshot(dataRef, (docSnap) => {
                    if (docSnap.exists()) setAllData(docSnap.data());
                    setLoading(false);
                }, () => setLoading(false));

                return () => { unsubscribeProfile(); unsubscribeData(); };
            }, [user]);

            const saveProfile = async (data) => {
                if (!user) return;
                try {
                    await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'profile'), data);
                    setProfile(data);
                    setShowOnboarding(false);
                } catch (e) {
                    console.error("Error saving profile", e);
                }
            };

            const updateDayData = async (day, updates) => {
                if (!user) return;
                setIsSaving(true);
                const dayExisting = allData[day] || { ...INITIAL_DAY_DATA };
                const newDayData = { ...dayExisting, ...updates };
                const newData = { ...allData, [day]: newDayData };
                setAllData(newData);
                try {
                    await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'ramadanData', 'main'), newData);
                } finally {
                    setTimeout(() => setIsSaving(false), 300);
                }
            };

            const calculateDayScore = (data) => {
                if (!data) return 0;
                let score = 0;
                let allRawatibDone = true;
                PRAYERS.forEach(pDef => {
                    const p = data.prayers?.[pDef.id] || INITIAL_DAY_DATA.prayers[pDef.id];
                    if (p.completed) {
                        score += 10;
                        if (profile.gender === 'female') {
                            if (p.group || p.masjid) score += 100;
                        } else {
                            if (p.group) score += 50;
                            if (p.masjid) score += 50;
                        }
                    }
                    if ((p.rawatib || 0) < pDef.target) allRawatibDone = false;
                    score += (p.rawatib || 0) * 5;
                });
                if (allRawatibDone) score += 100;
                if (data.fasting) score += 50;
                score += (Math.floor((data.tahajjudRakah || 0) / 2)) * 100;
                if (data.taraweehCompleted) score += 200;
                if (data.witrCompleted) score += 50;
                if (data.duhaCompleted) score += 50;
                if (data.quranJuz > 0) score += (data.quranJuz * 100);
                score += (data.salawatCount || 0) * 0.2;
                score += (data.azkarCount || 0) * 1.0;
                if (data.haddad) score += 60;
                if (data.sadaqah) score += 100;
                score += (data.manualEvaluation || 0);
                return score;
            };

            const currentDayData = allData[selectedDay] || INITIAL_DAY_DATA;
            const currentScore = calculateDayScore(currentDayData);
            const meterPercentage = Math.min(100, (currentScore / DAILY_TARGET) * 100);

            if (loading) return (
                <div className="min-h-screen bg-slate-950 flex flex-col items-center justify-center text-emerald-500 gap-4">
                    <div className="w-12 h-12 border-4 border-emerald-500 border-t-transparent rounded-full animate-spin"></div>
                    <p className="font-bold text-[10px] uppercase tracking-[0.2em] text-slate-500">Syncing Sanctuary...</p>
                </div>
            );

            if (showOnboarding) {
                return (
                    <div className="min-h-screen bg-[#020617] text-white flex items-center justify-center p-6">
                        <div className="w-full max-w-sm bg-slate-900/40 backdrop-blur-xl p-8 rounded-[40px] border border-white/5 shadow-2xl space-y-8">
                            <div className="text-center space-y-2">
                                <div className="inline-flex p-3 bg-emerald-500/10 rounded-2xl mb-2">
                                    <lucide.Sparkles className="text-emerald-500" size={32} />
                                </div>
                                <h2 className="text-2xl font-black italic tracking-tighter uppercase">Ramadan <span className="text-emerald-500">Pro</span></h2>
                                <p className="text-slate-500 text-[10px] font-bold uppercase tracking-widest">Identify Your Soul</p>
                            </div>
                            <div className="space-y-4">
                                <input 
                                    type="text" placeholder="Your Name"
                                    className="w-full bg-slate-900 border-2 border-slate-800 focus:border-emerald-500 rounded-2xl px-6 py-4 text-sm font-bold outline-none transition-all"
                                    value={profile.name} onChange={(e) => setProfile({ ...profile, name: e.target.value })}
                                />
                                <div className="grid grid-cols-2 gap-3">
                                    {['male', 'female'].map(g => (
                                        <button 
                                            key={g} onClick={() => setProfile({ ...profile, gender: g })}
                                            className={`py-4 rounded-2xl border-2 font-black text-[10px] uppercase transition-all ${profile.gender === g ? 'bg-emerald-500 border-emerald-400 text-slate-950' : 'bg-slate-900 border-slate-800 text-slate-500 opacity-60'}`}
                                        >
                                            {g === 'male' ? 'Brother' : 'Sister'}
                                        </button>
                                    ))}
                                </div>
                                <button 
                                    disabled={!profile.name || !profile.gender}
                                    onClick={() => saveProfile(profile)}
                                    className="w-full bg-white text-slate-950 font-black py-5 rounded-2xl text-xs uppercase disabled:opacity-20 active:scale-95 transition-all shadow-xl"
                                >
                                    Enter Sanctuary
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-[#020617] text-slate-100 pb-32">
                    <header className="px-6 py-5 flex justify-between items-center sticky top-0 bg-slate-950/80 backdrop-blur-2xl z-50 border-b border-white/5">
                        <div>
                            <h1 className="text-xl font-black italic tracking-tighter uppercase">RAMADAN <span className="text-emerald-500">PRO</span></h1>
                            <div className="flex items-center gap-1.5 mt-0.5">
                                <span className="text-[9px] text-slate-500 font-black uppercase tracking-widest">{profile.name}</span>
                                <div className={`w-1.5 h-1.5 rounded-full ${isSaving ? 'bg-emerald-500 animate-pulse' : 'bg-slate-800'}`}></div>
                            </div>
                        </div>
                        <div className="bg-emerald-500 px-5 py-2.5 rounded-2xl shadow-lg shadow-emerald-500/20 text-center">
                            <div className="text-sm font-black text-slate-950 leading-none">{Math.floor(currentScore)}</div>
                            <div className="text-[7px] font-black text-slate-950/50 uppercase tracking-tighter mt-1">Today's Pts</div>
                        </div>
                    </header>

                    <main className="px-5 py-6 max-w-md mx-auto space-y-8">
                        {activeTab === 'dashboard' && (
                            <div className="space-y-6 animate-in fade-in duration-700">
                                <section className="bg-slate-900/40 backdrop-blur-lg rounded-[32px] p-8 border border-white/5 shadow-xl">
                                    <h2 className="text-[10px] font-black text-slate-500 uppercase mb-6 tracking-widest text-center italic">Spiritual Calendar</h2>
                                    <div className="grid grid-cols-6 gap-2">
                                        {Array.from({ length: DAYS_OF_RAMADAN }, (_, i) => {
                                            const day = i + 1;
                                            const score = calculateDayScore(allData[day]);
                                            const pct = (score / DAILY_TARGET) * 100;
                                            let color = "bg-slate-900 text-slate-700";
                                            if (score > 0) {
                                                if (pct >= 80) color = "bg-emerald-500 text-slate-950 shadow-lg shadow-emerald-500/20 scale-105";
                                                else if (pct >= 40) color = "bg-emerald-800 text-emerald-100";
                                                else color = "bg-amber-600 text-white";
                                            }
                                            return (
                                                <div 
                                                    key={day} onClick={() => { setSelectedDay(day); setActiveTab('log'); }}
                                                    className={`aspect-square rounded-xl flex items-center justify-center text-[10px] font-black transition-all cursor-pointer ${color} ${selectedDay === day ? 'ring-2 ring-white ring-offset-4 ring-offset-slate-950 z-10' : 'hover:scale-105'}`}
                                                >
                                                    {day}
                                                </div>
                                            );
                                        })}
                                    </div>
                                </section>
                            </div>
                        )}

                        {activeTab === 'log' && (
                            <div className="space-y-8 animate-in slide-in-from-bottom-6 duration-500">
                                <div className="flex items-center justify-between bg-slate-900/30 rounded-3xl p-2 border border-white/5 shadow-lg">
                                    <button onClick={() => setSelectedDay(d => Math.max(1, d-1))} className="p-4 text-slate-500 hover:text-white transition-colors"><lucide.ChevronLeft size={24}/></button>
                                    <span className="font-black text-xs uppercase tracking-[0.4em] text-emerald-500 italic">Day {selectedDay}</span>
                                    <button onClick={() => setSelectedDay(d => Math.min(DAYS_OF_RAMADAN, d+1))} className="p-4 text-slate-500 hover:text-white transition-colors"><lucide.ChevronRight size={24}/></button>
                                </div>

                                <div className="bg-slate-900/40 backdrop-blur-lg rounded-[40px] p-8 space-y-4 border border-emerald-500/10 shadow-xl relative overflow-hidden">
                                    <div className="flex justify-between items-end">
                                        <div className="flex flex-col">
                                            <span className="text-[9px] font-black uppercase text-slate-500 tracking-widest italic">Target Goal</span>
                                            <span className="text-lg font-black italic tracking-tighter">PROGRESS <span className="text-emerald-500">METER</span></span>
                                        </div>
                                        <span className="text-sm font-black text-emerald-400">{Math.round(meterPercentage)}%</span>
                                    </div>
                                    <div className="h-4 bg-slate-950 rounded-full overflow-hidden p-0.5 border border-white/5">
                                        <div 
                                            className="h-full bg-gradient-to-r from-emerald-600 to-emerald-400 rounded-full transition-all duration-1000 shadow-[0_0_15px_rgba(16,185,129,0.4)]" 
                                            style={{ width: `${meterPercentage}%` }} 
                                        />
                                    </div>
                                </div>

                                <section className="space-y-3">
                                    <h3 className="text-[10px] font-black uppercase text-slate-500 px-2 tracking-[0.2em] italic">The Five Pillars</h3>
                                    {PRAYERS.map(p => {
                                        const d = currentDayData.prayers?.[p.id] || { ...INITIAL_DAY_DATA.prayers[p.id] };
                                        return (
                                            <div key={p.id} className="bg-slate-900/30 rounded-[32px] p-3 flex items-center gap-4 border border-transparent hover:border-emerald-500/20 transition-all">
                                                <button 
                                                    onClick={() => {
                                                        const ps = { ...(currentDayData.prayers || INITIAL_DAY_DATA.prayers) };
                                                        ps[p.id] = { ...d, completed: !d.completed };
                                                        updateDayData(selectedDay, { prayers: ps });
                                                    }}
                                                    className={`w-14 h-14 rounded-3xl flex items-center justify-center transition-all ${d.completed ? 'bg-emerald-500 text-slate-950 scale-105 shadow-xl shadow-emerald-500/20' : 'bg-slate-800/50 text-slate-600'}`}
                                                >
                                                    <lucide.Check size={28} strokeWidth={4} />
                                                </button>
                                                <div className="grow">
                                                    <div className="font-black text-sm uppercase italic tracking-tight">{p.name}</div>
                                                    <div className="flex items-center gap-2 mt-1.5">
                                                        <div className="flex items-center bg-slate-950/50 rounded-xl px-2.5 py-1.5 border border-white/5">
                                                            <button onClick={() => {
                                                                const ps = { ...(currentDayData.prayers || INITIAL_DAY_DATA.prayers) };
                                                                ps[p.id] = { ...d, rawatib: Math.max(0, (d.rawatib || 0) - 2) };
                                                                updateDayData(selectedDay, { prayers: ps });
                                                            }} className="p-1 text-slate-600 hover:text-white"><lucide.Minus size={12}/></button>
                                                            <span className="text-[11px] font-black text-emerald-500 w-6 text-center">{d.rawatib || 0}</span>
                                                            <button onClick={() => {
                                                                const ps = { ...(currentDayData.prayers || INITIAL_DAY_DATA.prayers) };
                                                                ps[p.id] = { ...d, rawatib: (d.rawatib || 0) + 2 };
                                                                updateDayData(selectedDay, { prayers: ps });
                                                            }} className="p-1 text-slate-600 hover:text-white"><lucide.Plus size={12}/></button>
                                                        </div>
                                                        <span className="text-[8px] font-bold text-slate-500 uppercase tracking-widest">Rawatib</span>
                                                    </div>
                                                </div>
                                                <div className="flex gap-2">
                                                    <button 
                                                        onClick={() => {
                                                            const ps = { ...(currentDayData.prayers || INITIAL_DAY_DATA.prayers) };
                                                            ps[p.id] = { ...d, group: !d.group };
                                                            updateDayData(selectedDay, { prayers: ps });
                                                        }}
                                                        className={`px-3 py-3 rounded-2xl text-[9px] font-black uppercase border-2 transition-all ${d.group ? 'bg-emerald-500 border-emerald-400 text-slate-950' : 'bg-slate-950 border-transparent text-slate-700'}`}
                                                    >
                                                        GRP
                                                    </button>
                                                    {profile.gender !== 'female' && (
                                                        <button 
                                                            onClick={() => {
                                                                const ps = { ...(currentDayData.prayers || INITIAL_DAY_DATA.prayers) };
                                                                ps[p.id] = { ...d, masjid: !d.masjid };
                                                                updateDayData(selectedDay, { prayers: ps });
                                                            }}
                                                            className={`px-3 py-3 rounded-2xl text-[9px] font-black uppercase border-2 transition-all ${d.masjid ? 'bg-indigo-600 border-indigo-400 text-white shadow-lg shadow-indigo-500/20' : 'bg-slate-950 border-transparent text-slate-700'}`}
                                                        >
                                                            MSJ
                                                        </button>
                                                    )}
                                                </div>
                                            </div>
                                        );
                                    })}
                                </section>

                                <section className="grid grid-cols-2 gap-4">
                                    <div className="bg-slate-900/30 rounded-[32px] p-6 flex flex-col items-center gap-4 border border-white/5">
                                        <span className="text-[9px] font-black text-slate-500 uppercase tracking-widest italic flex items-center gap-2"><lucide.Moon size={12}/> Tahajjud</span>
                                        <div className="flex items-center gap-5">
                                            <button onClick={() => updateDayData(selectedDay, { tahajjudRakah: Math.max(0, (currentDayData.tahajjudRakah || 0) - 2) })} className="p-3 bg-slate-950 rounded-2xl hover:bg-slate-800 transition-colors border border-white/5"><lucide.Minus size={16}/></button>
                                            <span className="font-black text-2xl text-emerald-500 italic tabular-nums">{currentDayData.tahajjudRakah || 0}</span>
                                            <button onClick={() => updateDayData(selectedDay, { tahajjudRakah: (currentDayData.tahajjudRakah || 0) + 2 })} className="p-3 bg-slate-950 rounded-2xl hover:bg-slate-800 transition-colors border border-white/5"><lucide.Plus size={16}/></button>
                                        </div>
                                    </div>
                                    <div className="bg-slate-900/30 rounded-[32px] p-6 flex flex-col items-center gap-4 border border-white/5">
                                        <span className="text-[9px] font-black text-slate-500 uppercase tracking-widest italic flex items-center gap-2"><lucide.BookOpen size={12}/> Quran Juz</span>
                                        <div className="flex items-center gap-5">
                                            <button onClick={() => updateDayData(selectedDay, { quranJuz: Math.max(0, (currentDayData.quranJuz || 0) - 1) })} className="p-3 bg-slate-950 rounded-2xl hover:bg-slate-800 transition-colors border border-white/5"><lucide.Minus size={16}/></button>
                                            <span className="font-black text-2xl text-emerald-500 italic tabular-nums">{currentDayData.quranJuz || 0}</span>
                                            <button onClick={() => updateDayData(selectedDay, { quranJuz: (currentDayData.quranJuz || 0) + 1 })} className="p-3 bg-slate-950 rounded-2xl hover:bg-slate-800 transition-colors border border-white/5"><lucide.Plus size={16}/></button>
                                        </div>
                                    </div>
                                </section>

                                <section className="grid grid-cols-3 gap-3">
                                    {[
                                        { id: 'taraweehCompleted', name: 'Taraweeh', icon: lucide.Moon },
                                        { id: 'duhaCompleted', name: 'Duha', icon: lucide.Sun },
                                        { id: 'sadaqah', name: 'Sadaqah', icon: lucide.Heart },
                                    ].map(item => (
                                        <button
                                            key={item.id} onClick={() => updateDayData(selectedDay, { [item.id]: !currentDayData[item.id] })}
                                            className={`aspect-square rounded-[32px] flex flex-col items-center justify-center gap-3 border-2 transition-all ${currentDayData[item.id] ? 'bg-emerald-500 border-emerald-400 text-slate-950 shadow-xl shadow-emerald-500/20 scale-105' : 'bg-slate-900/30 border-slate-800 text-slate-600'}`}
                                        >
                                            <item.icon size={24} />
                                            <span className="text-[9px] font-black uppercase tracking-tighter italic">{item.name}</span>
                                        </button>
                                    ))}
                                </section>

                                <section className="bg-slate-900/40 rounded-[40px] p-8 space-y-6 border border-white/5 shadow-2xl">
                                    <div className="flex justify-between items-center">
                                        <div className="flex flex-col">
                                            <span className="text-[10px] font-black text-slate-400 uppercase tracking-widest italic">Personal Audit</span>
                                            <span className="text-xs font-black text-white italic">SPIRITUAL <span className="text-amber-500">QUALITY</span></span>
                                        </div>
                                        <span className="text-xs font-black text-amber-500">+{currentDayData.manualEvaluation || 0} pts</span>
                                    </div>
                                    <input 
                                        type="range" min="0" max="100" step="10"
                                        value={currentDayData.manualEvaluation || 0}
                                        onChange={e => updateDayData(selectedDay, { manualEvaluation: parseInt(e.target.value) })}
                                        className="w-full h-2 bg-slate-950 rounded-full appearance-none cursor-pointer accent-emerald-500 border border-white/5"
                                    />
                                    <textarea 
                                        className="w-full bg-slate-950/40 border border-white/5 rounded-3xl p-5 text-sm font-medium outline-none focus:border-emerald-500/40 min-h-[160px] transition-all resize-none text-slate-300 placeholder:text-slate-700"
                                        placeholder="Write your soul's reflection for today..."
                                        value={currentDayData.reflections || ""}
                                        onChange={e => updateDayData(selectedDay, { reflections: e.target.value })}
                                    />
                                </section>
                            </div>
                        )}
                    </main>

                    <nav className="fixed bottom-0 left-0 right-0 bg-slate-950/80 backdrop-blur-2xl border-t border-white/10 px-10 pt-5 pb-10 flex justify-around items-center z-[60] safe-bottom rounded-t-[40px] shadow-2xl">
                        <button 
                            onClick={() => setActiveTab('dashboard')} 
                            className={`flex flex-col items-center gap-2.5 transition-all ${activeTab === 'dashboard' ? 'text-emerald-400 scale-110' : 'text-slate-600 hover:text-slate-400'}`}
                        >
                            <lucide.LayoutDashboard size={28} />
                            <span className="text-[9px] font-black uppercase tracking-[0.2em]">Roadmap</span>
                        </button>
                        <button 
                            onClick={() => setActiveTab('log')} 
                            className={`flex flex-col items-center gap-2.5 transition-all ${activeTab === 'log' ? 'text-emerald-400 scale-110' : 'text-slate-600 hover:text-slate-400'}`}
                        >
                            <lucide.ClipboardList size={28} />
                            <span className="text-[9px] font-black uppercase tracking-[0.2em]">Journal</span>
                        </button>
                    </nav>
                </div>
            );
        }

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
